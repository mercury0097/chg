# 机器人控制接口文档

## 接口列表

本文档包含机器人（Dog、Palqiqi）的所有HTTP API接口定义，供微信小程序对接使用。

### 接口列表总览

| 序号 | 接口分类 | 接口名称 | 请求方式 | 接口路径 | 说明 |
|------|----------|----------|----------|----------|------|
| 2.1 | 设备信息 | 获取设备信息 | GET | http://{robot_ip}:80/api/v1/device/info | 获取设备型号与能力 |
| 2.2 | 控制 | 发送动作指令 | POST | http://{robot_ip}:80/api/v1/device/action | 触发机器人动作 |
| 2.3 | 状态 | 获取设备状态 | GET | http://{robot_ip}:80/api/v1/device/status | 查询当前动作/空闲/电量/音量 |
| 2.4 | 音量 | 获取音量 | GET | http://{robot_ip}:80/api/v1/device/volume | 查询当前音量 |
| 2.5 | 音量 | 设置音量 | POST | http://{robot_ip}:80/api/v1/device/volume | 设置扬声器音量 |

**💡 小程序开发者重要提示**：

**配网方式**：
- 使用 `<web-view>` 组件打开 http://192.168.4.1/
- 配网由机器人网页自动完成，小程序无需直接调用配网接口
- 配网成功后自动通过 `wx.miniProgram.postMessage` 发送IP到小程序
- **您只需要关注：控制接口（2.1-2.5）**

**📖 阅读建议**：
- 直接看"二、机器人控制接口"和"三、完整使用流程"章节

---

## 一、配网接入说明

**⚠️ 小程序无需直接调用配网接口**

配网页面由机器人内部实现，小程序通过 `<web-view>` 打开配网页面即可，IP 会通过 `wx.miniProgram.postMessage` 自动回传。

**小程序只需要**：
1. 使用 `<web-view src="http://192.168.4.1/" />` 打开配网页面
2. 实现 `handleMessage` 接收配网完成后返回的IP地址

---

**🎯 小程序集成**：

```xml
<!-- 小程序页面 -->
<web-view src="http://192.168.4.1/" bindmessage="handleMessage"></web-view>
```

```javascript
// 配网成功后，页面会自动发送IP
Page({
  handleMessage(e) {
    const messages = e.detail.data;
    for (let msg of messages) {
      if (msg.type === 'wifi_config_success' && msg.ip) {
        // ✅ 自动接收IP地址
        wx.setStorageSync('robot_ip', msg.ip);
        wx.showToast({ title: '配网成功', icon: 'success' });
      }
    }
  }
});
```

**⚠️ IP地址重要提示**：
1. **IP来源**：返回的IP是机器人配网测试阶段从路由器DHCP获取的地址
2. **有效性**：大多数家庭路由器会为同一设备分配相同IP，但**不保证重启后IP不变**
3. **失效处理**：如果小程序使用保存的IP无法连接机器人，应提示用户"重新配网"
4. **最佳实践**：
   - 小程序应实现"自动重连"机制（检测IP是否可达）
   - 提供"手动输入IP"选项作为备用方案
   - 每次成功连接后更新保存的IP地址

---

## 二、机器人控制接口

### 2.1 获取设备信息

**接口描述**：获取设备型号、能力列表、固件版本

**请求方式**：GET

**接口路径**：`http://{robot_ip}:80/api/v1/device/info`

**请求示例**：
```
GET http://192.168.1.100:80/api/v1/device/info
```

**响应示例（成功 - Dog机器人）**：
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "device_id": "dog-001",
    "model": "dog",
    "capabilities": [
      "walk_forward",
      "walk_backward",
      "turn_left",
      "turn_right",
      "home",
      "stop",
      "say_hello",
      "sway_back_forth",
      "push_up",
      "sleep",
      "battery",
      "status",
      "volume"
    ],
    "fw_version": "1.0.0"
  }
}
```

**响应示例（成功 - Palqiqi机器人）**：
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "device_id": "palqiqi-001",
    "model": "palqiqi",
    "capabilities": [
      "walk_forward",
      "walk_backward",
      "turn_left",
      "turn_right",
      "home",
      "stop",
      "jump",
      "swing",
      "moonwalk",
      "bend",
      "shake_leg",
      "updown",
      "look_around",
      "hands_up",
      "hands_down",
      "hand_wave",
      "battery",
      "status",
      "volume"
    ],
    "fw_version": "1.4.4"
  }
}
```

**响应示例（失败）**：
```json
{
  "code": 500,
  "message": "服务器错误",
  "data": {}
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| code | number | 是 | 状态码（200=成功，500=服务器错误） |
| message | string | 是 | 响应消息 |
| data.device_id | string | 是 | 设备唯一ID |
| data.model | string | 是 | 设备型号（dog/palqiqi） |
| data.capabilities | array | 是 | 支持的动作和功能列表 |
| data.fw_version | string | 是 | 固件版本号 |

**说明**：
- 此接口无需鉴权
- 小程序应根据 `capabilities` 动态显示可用功能
- 不同型号机器人的 `capabilities` 不同

---

### 2.2 发送动作指令

**接口描述**：触发机器人执行指定动作

**请求方式**：POST

**接口路径**：`http://{robot_ip}:80/api/v1/device/action`

**请求示例**：
```
POST http://192.168.1.100:80/api/v1/device/action
Content-Type: application/json
```

**请求体**：
```json
{
  "action": "walk_forward",
  "steps": 4,
  "speed": 1000
}
```

**响应示例（成功）**：
```json
{
  "code": 200,
  "message": "执行成功",
  "data": {
    "action_id": "a1b2c3"
  }
}
```

**响应示例（失败 - 动作不支持）**：
```json
{
  "code": 400,
  "message": "动作执行失败",
  "data": {}
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **请求字段** |
| action | string | 是 | 动作名称（见下方动作列表） |
| steps | number | 否 | 步数/次数（默认4） |
| speed | number | 否 | 速度，单位毫秒（默认1000） |
| **响应字段** |
| code | number | 是 | 状态码（200=成功，400=动作失败） |
| message | string | 是 | 响应消息 |
| data.action_id | string | 是 | 动作ID，用于标识本次动作 |

**Dog机器人动作列表**：

| 动作名 | 说明 | 是否需要steps/speed |
|--------|------|---------------------|
| walk_forward | 向前走 | 是 |
| walk_backward | 向后退 | 是 |
| turn_left | 向左转 | 是 |
| turn_right | 向右转 | 是 |
| home | 回到休息姿态 | 否 |
| stop | 立即停止 | 否 |
| say_hello | 打招呼 | 是 |
| sway_back_forth | 前后摇摆 | 是 |
| push_up | 俯卧撑 | 是 |
| sleep | 睡觉姿态 | 否 |

**Palqiqi机器人动作列表**：

| 动作名 | 说明 | 是否需要steps/speed |
|--------|------|---------------------|
| walk_forward | 向前走 | 是 |
| walk_backward | 向后退 | 是 |
| turn_left | 向左转 | 是 |
| turn_right | 向右转 | 是 |
| home | 回到休息姿态 | 否 |
| stop | 立即停止 | 否 |
| jump | 跳跃 | 是 |
| swing | 左右摇摆 | 是 |
| moonwalk | 太空步 | 是 |
| bend | 弯腰 | 是 |
| shake_leg | 抖腿 | 是 |
| updown | 上下运动 | 是 |
| look_around | 左右看 | 仅speed |
| hands_up | 举手（需手部舵机） | 仅speed |
| hands_down | 放手（需手部舵机） | 仅speed |
| hand_wave | 挥手（需手部舵机） | 仅speed |

**说明**：
- `home`/`stop`/`sleep` 可省略 `steps`/`speed` 参数
- 建议默认值：`steps=4`, `speed=1000`

---

### 2.3 获取设备状态

**接口描述**：查询当前动作、是否空闲、电量

**请求方式**：GET

**接口路径**：`http://{robot_ip}:80/api/v1/device/status`

**请求示例**：
```
GET http://192.168.1.100:80/api/v1/device/status
```

**响应示例（成功）**：
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "action": "walk_forward",
    "is_idle": false,
    "battery": 76,
    "volume": 80
  }
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **响应字段** |
| code | number | 是 | 状态码（200=成功） |
| message | string | 是 | 响应消息 |
| data.action | string | 是 | 当前正在执行的动作名（空闲时为空字符串） |
| data.is_idle | boolean | 是 | 是否空闲（true=空闲，false=执行中） |
| data.battery | number | 是 | 电池电量百分比（0-100） |
| data.volume | number | 是 | 当前音量百分比（0-100） |

**说明**：
- 建议每2秒轮询一次
- 可用于显示电量、音量和运行状态

---

### 2.4 获取音量

**接口描述**：查询机器人当前音量

**请求方式**：GET

**接口路径**：`http://{robot_ip}:80/api/v1/device/volume`

**请求示例**：
```
GET http://192.168.1.100:80/api/v1/device/volume
```

**响应示例（成功）**：
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "volume": 80
  }
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **响应字段** |
| code | number | 是 | 状态码（200=成功） |
| message | string | 是 | 响应消息 |
| data.volume | number | 是 | 当前音量百分比（0-100） |

**说明**：
- 音量范围：0-100（0=静音，100=最大音量）
- 无需鉴权

---

### 2.5 设置音量

**接口描述**：设置机器人扬声器音量

**请求方式**：POST

**接口路径**：`http://{robot_ip}:80/api/v1/device/volume`

**请求示例**：
```
POST http://192.168.1.100:80/api/v1/device/volume
Content-Type: application/json
```

**请求体**：
```json
{
  "volume": 80
}
```

**响应示例（成功）**：
```json
{
  "code": 200,
  "message": "音量设置成功",
  "data": {
    "volume": 80
  }
}
```

**响应示例（失败 - 参数错误）**：
```json
{
  "code": 400,
  "message": "缺少volume参数或参数类型错误",
  "data": {}
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **请求字段** |
| volume | number | 是 | 音量百分比（0-100） |
| **响应字段** |
| code | number | 是 | 状态码（200=成功，400=参数错误，500=设置失败） |
| message | string | 是 | 响应消息 |
| data.volume | number | 是 | 设置后的实际音量 |

**说明**：
- 音量范围：0-100，超出范围会自动限制
- 0表示静音，100表示最大音量
- 音量设置会立即生效
- 音量值会保存到NVS，重启后保持

## 三、完整使用流程

### 首次配网流程

```
1. 用户长按机器人按钮 → 进入配网模式
2. 手机连接机器人热点 → Xiaozhi-XXXX
3. 小程序打开web-view → 加载 http://192.168.4.1/
4. 用户在配网页面选择WiFi并输入密码 → 点击Connect
5. 机器人连接WiFi成功 → 获取IP地址
6. ✨ 配网页面自动发送IP到小程序 → wx.miniProgram.postMessage({ip: "192.168.1.100"})
7. 小程序handleMessage接收IP → 保存到本地存储
8. 配网完成页面倒计时3秒后自动返回小程序
9. 提示用户连回家里WiFi
10. 完成！
```

### 日常使用流程

```
1. 小程序读取本地存储的IP → "192.168.1.100"
2. 调用 GET http://192.168.1.100/api/v1/device/info → 验证连接
3. 调用 POST http://192.168.1.100/api/v1/device/action → 控制机器人
4. 定时调用 GET http://192.168.1.100/api/v1/device/status → 监控状态（建议2秒轮询）
```

---

## 四、错误码说明

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| 200 | 成功 | 正常处理 |
| 400 | 请求参数错误或动作失败 | 检查参数格式和动作名是否正确 |
| 500 | 服务器内部错误 | 稍后重试或重启机器人 |

---

## 五、注意事项

### 网络要求
1. **配网阶段**：手机必须连接到机器人热点（Robot-xxx）
2. **控制阶段**：手机和机器人必须在同一WiFi网络
3. **IP变化处理**：
   - 机器人重启后IP可能变化（取决于路由器DHCP设置）
   - 小程序应实现连接失败时的"重新配网"引导
   - 建议每次控制前先调用 `/api/v1/device/info` 验证连接

### 动作参数
1. `steps`: 建议范围 1-20，默认4
2. `speed`: 建议范围 500-2000（毫秒），默认1000
3. 数值越小速度越快

### 小程序开发建议

1. **配网阶段（使用web-view）**
   
   ```xml
   <!-- pages/config/config.wxml -->
   <web-view src="http://192.168.4.1/" bindmessage="handleMessage"></web-view>
   ```
   
   ```javascript
   // pages/config/config.js
   Page({
     handleMessage(e) {
       const messages = e.detail.data;
       for (let msg of messages) {
         if (msg.type === 'wifi_config_success' && msg.ip) {
           // 自动接收IP
           wx.setStorageSync('robot_ip', msg.ip);
           wx.setStorageSync('config_time', Date.now());
           wx.showToast({ title: '配网成功', icon: 'success' });
           
           // 跳转到控制页面
           setTimeout(() => {
             wx.switchTab({ url: '/pages/control/control' });
           }, 1500);
         }
       }
     }
   });
   ```
   
2. **连接管理**
   - 控制页面打开时自动读取IP并连接
   - 先调用 `GET /api/v1/device/info` 验证IP是否可达
   - 连接失败（超时3秒）时提示"机器人离线，是否重新配网？"
   
3. **状态监控**
   - 建议每2-3秒轮询一次 `/api/v1/device/status` 更新电量、音量和动作状态
   - 连续失败3次则判定为断线
   - 音量滑块初始值应从 `/api/v1/device/status` 或 `/api/v1/device/volume` 获取
   
4. **容错处理**
   - 提供"重新配网"入口（清除本地IP缓存）
   - 提供"手动输入IP"选项（高级用户）
   - 显示当前使用的IP地址（便于调试）

---

## 六、设备型号差异

### Dog 机器人
- 型号标识：`"dog"`
- 特有动作：`say_hello`, `sway_back_forth`, `push_up`, `sleep`
- 舵机数量：4个（四足）

### Palqiqi 机器人
- 型号标识：`"palqiqi"`
- 特有动作：`jump`, `swing`, `moonwalk`, `bend`, `shake_leg`, `updown`, `look_around`
- 手部动作：`hands_up`, `hands_down`, `hand_wave`（部分型号支持）
- 舵机数量：6个（双足+双手）

---

## 七、测试方法

使用curl命令测试（开发阶段）：

```bash
# 1. 获取设备信息
curl http://192.168.1.100/api/v1/device/info

# 2. 执行动作
curl -X POST http://192.168.1.100/api/v1/device/action \
  -H "Content-Type: application/json" \
  -d '{"action":"walk_forward","steps":4,"speed":1000}'

# 3. 获取状态
curl "http://192.168.1.100/api/v1/device/status"

# 4. 获取音量
curl "http://192.168.1.100/api/v1/device/volume"

# 5. 设置音量
curl -X POST http://192.168.1.100/api/v1/device/volume \
  -H "Content-Type: application/json" \
  -d '{"volume":80}'
```

---

**版本**：v1.1  
**更新时间**：2026-01-20  
**更新内容**：
- 增加小程序web-view自动接收IP功能说明
- 更新配网流程，增加推荐方案（web-view嵌入）
- 完善小程序开发建议，提供web-view集成代码示例

**联系人**：后端开发负责人
